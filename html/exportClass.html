<!DOCTYPE html>
<html>
<head>
  <title>Datastage Class Data Export</title>
  <meta charset="UTF-8">
  <style type="text/css">
    body { background-color:#FFF8E8;}
    H1   { text-align: center;}
    p + p { margin-top: 0.5em; } 
  </style>
  <script type="text/javascript">

    function startProgressStream() {
      var xmlHttp = null;
      var courseID   = document.getElementById("courseID").value;
      var fileAction = document.getElementById("fileAction").checked;
      //var theURL     = "http://mono.stanford.edu/code/exportClass.py";
      var theURL = window.location.origin + "/code/exportClass.py";

      console.log("theURL: " + theURL) //*******
      console.log("StartProgressStream() called.") //*******

      theURL += "?courseID="+courseID+"&fileAction="+fileAction;

      if(typeof(EventSource) == "undefined") {
         // Browser doesn't support server-send events.
         // Just start the export without giving on-the-fly
         // feedback:
         window.location = theURL
         return;
      }

      // Start exportClass.py at the server, listening
      // for an event stream from that program:
      var source = new EventSource(theURL);

      // Listener for all strings from server that start with 'data: ':
      source.addEventListener('message', function(event) {
         // Add the string to the bottom of the screen:
         document.getElementById("progress").innerHTML += event.data + "<br>";
         // If 'clear progress info' button is not visible, make it
         // visible:
         if (!clrProgressButtonVisible()) {
             exposeClearProgressButton()
         }

      }, false);

      // Listener for exportClass.py saying that it's done:
      source.addEventListener('allDone', function(event) {
         console.log("Got 'allDone'") //********8
         source.close()
         }, false);
    }

    function clrProgressDiv() {
        document.getElementById("progress").innerHTML = "";
        hideClearProgressButton()
    }

    function exposeClearProgressButton() {
        document.getElementById("clrProgBtn").style.visibility="visible";
    }

    function hideClearProgressButton() {
        document.getElementById("clrProgBtn").style.visibility="hidden";
    }

    function clrProgressButtonVisible() {
        return document.getElementById("clrProgBtn").style.visibility == "visible";
    }

  </script>

</head>
<body>

  <h1>Export One Class to CSV</h1>

    Course to export (may use MySQL regex): <input type="text"
						   id="courseID">
    <input type="checkbox" id="fileAction" value="xpunge">Remove 
    any previous exports of same class<br>

    <input type="button" value="Export Class" onclick="startProgressStream()">

  <br>
  <hr>
  <div id="tmpButtons">
    <input type="button" 
	   id="clrProgBtn"
	   value="Clear Progress Info"
           onclick="clrProgressDiv()" 
	   style="visibility: hidden">
  </div>
  <div id="progress"></div>

</body>
</html>
